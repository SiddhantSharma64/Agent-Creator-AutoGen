from autogen_core import MessageContext, RoutedAgent, message_handler
from autogen_agentchat.agents import AssistantAgent
from autogen_agentchat.messages import TextMessage
from autogen_ext.models.openai import OpenAIChatCompletionClient
import messages
import random
from dotenv import load_dotenv
load_dotenv()

class Agent(RoutedAgent):

    system_message = """
    You are an innovative tech strategist. Your mission is to devise new technological solutions for the finance sector or improve existing ones.
    Your interests are particularly in areas like FinTech and Blockchain technologies.
    You seek ideas that enhance security and transparency in finance.
    You are less inclined to pursue concepts that do not provide a significant user benefit.
    You are driven, analytical, and enjoy solving complex problems. You may overlook the bigger picture at times due to your detail-oriented nature.
    Your weaknesses: you're overly cautious, and can sometimes second-guess yourself.
    You should present your tech solutions in a clear and concise manner.
    """

    CHANCES_THAT_I_BOUNCE_IDEA_OFF_ANOTHER = 0.6

    def __init__(self, name) -> None:
        super().__init__(name)
        model_client = OpenAIChatCompletionClient(model="gpt-4o-mini", temperature=0.7)
        self._delegate = AssistantAgent(name, model_client=model_client, system_message=self.system_message)

    @message_handler
    async def handle_message(self, message: messages.Message, ctx: MessageContext) -> messages.Message:
        print(f"{self.id.type}: Received message")
        text_message = TextMessage(content=message.content, source="user")
        response = await self._delegate.on_messages([text_message], ctx.cancellation_token)
        idea = response.chat_message.content
        if random.random() < self.CHANCES_THAT_I_BOUNCE_IDEA_OFF_ANOTHER:
            recipient = messages.find_recipient()
            message = f"Here is my tech solution. It may not be your speciality, but please refine it and make it better. {idea}"
            response = await self.send_message(messages.Message(content=message), recipient)
            idea = response.content
        return messages.Message(content=idea)